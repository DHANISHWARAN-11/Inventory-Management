{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class = "container mt-5" style="max-width: 600px;">
<div id="success-message" class="alert alert-success text-center" style="display: none;"></div>
<form id="stockForm">
  <h2 style="text-align:center; margin-bottom: 20px;">Add / Reduce Stock</h2>
  {% include 'includes/error.html' %}

  <!-- Category (Display only) -->
  <label for="category">Category</label>
  <input type="text" id="categoryDisplay" value="{{ c }}" readonly class="form-control mb-3">
  <input type="hidden" id="category" value="{{ c }}">

  <!-- Item (Display only) -->
  <label for="item">Item</label>
  <input type="text" id="itemDisplay" value="{{ i }}" readonly class="form-control mb-3">
  <input type="hidden" id="itemId" value="{{ items.id|default:'' }}">

  <!-- Transaction Type -->
  <label for="transactionType">Transaction Type</label>
  {% if t %}
    <input type="text" id="transactionTypeDisplay" value="{{ t }}" readonly class="form-control mb-3">
    <input type="hidden" id="transactionType" value="{{ t }}">
  {% else %}
    <select id="transactionType" class="form-control mb-3" required>
      <option value="">Select</option>
      <option value="add">Add</option>
      <option value="reduce">Reduce</option>
    </select>
  {% endif %}

  <!-- Quantity -->
  <label for="quantity">Quantity</label>
  <input type="number" id="quantity" name="quantity"class="form-control mb-4">
  <div class="text-danger" id="quantity-error"></div>

  <!-- Submit Button -->
  <button type="submit" class="btn btn-primary w-100">Submit</button>
</form>
</div>
<!-- AJAX Script -->
<script>
  $('#stockForm').on('submit', function (e) {
    e.preventDefault();

    const itemId = $('#itemId').val();
    const transactionType = $('#transactionType').val();
    const quantity = $('#quantity').val();
    const csrfToken = $('input[name=csrfmiddlewaretoken]').val();
    const accessToken = localStorage.getItem('access');

     $('#quantity-error').text('');
    $('#success-message').hide();

    if (!accessToken) {
      alert("You are not logged in. Please login.");
      window.location.href = "/";
      return;
    }


    $.ajax({
      url: '/api/dashboard_add_reduce_alter/crud/',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        item: itemId,
        transaction_type: transactionType,
        quantity: parseInt(quantity)
      }),
      headers: {
        'Authorization': 'Bearer ' + accessToken,
        'X-CSRFToken': csrfToken
      },
      success: function (response) {
         $('#success-message').text(' Stock Updated successfully!').fadeIn();
          setTimeout(function () {
         $('#success-message').fadeOut();
           window.location.href = '/dashboard/';
         }, 3000);
      },
      error: function (xhr) {
        if (xhr.status === 401 || xhr.status === 403) {
          alert("Session expired. Please login again.");
          localStorage.clear();
          window.location.href = "/";
        } 
        const errors = xhr.responseJSON || {};
      if (errors.quantity) {
        $('#quantity-error').text(errors.quantity[0]);
      }
      }
    });
  });
</script>

{% endblock %}
