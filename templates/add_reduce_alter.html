{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2 style="text-align:center; margin-bottom: 20px;">Add / Reduce Stock</h2>

<form id="stockForm">
  {% csrf_token %}
  {% include 'includes/error.html' %}

  <!-- Category (Display only) -->
  <label for="category">Category</label>
  <input type="text" id="categoryDisplay" value="{{ c }}" readonly class="form-control mb-3">
  <input type="hidden" id="category" value="{{ c }}">

  <!-- Item (Display only) -->
  <label for="item">Item</label>
  <input type="text" id="itemDisplay" value="{{ i }}" readonly class="form-control mb-3">
  <input type="hidden" id="itemId" value="{{ items.id|default:'' }}">

  <!-- Transaction Type -->
  <label for="transactionType">Transaction Type</label>
  {% if t %}
    <input type="text" id="transactionTypeDisplay" value="{{ t }}" readonly class="form-control mb-3">
    <input type="hidden" id="transactionType" value="{{ t }}">
  {% else %}
    <select id="transactionType" class="form-control mb-3" required>
      <option value="">Select</option>
      <option value="add">Add</option>
      <option value="reduce">Reduce</option>
    </select>
  {% endif %}

  <!-- Quantity -->
  <label for="quantity">Quantity</label>
  <input type="number" id="quantity" name="quantity"class="form-control mb-4">

  <!-- Submit Button -->
  <button type="submit" class="btn btn-primary w-100">Submit</button>
</form>

<!-- AJAX Script -->
<script>
  $('#stockForm').on('submit', function (e) {
    e.preventDefault();

    const itemId = $('#itemId').val();
    const transactionType = $('#transactionType').val();
    const quantity = $('#quantity').val();
    const csrfToken = $('input[name=csrfmiddlewaretoken]').val();
    const accessToken = localStorage.getItem('access');

    if (!accessToken) {
      alert("You are not logged in. Please login.");
      window.location.href = "/";
      return;
    }

    if (!itemId || !transactionType || !quantity) {
      alert("All fields are required.");
      return;
    }

    $.ajax({
      url: '/api/dashboard_add_reduce_alter/crud/',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        item: itemId,
        transaction_type: transactionType,
        quantity: parseInt(quantity)
      }),
      headers: {
        'Authorization': 'Bearer ' + accessToken,
        'X-CSRFToken': csrfToken
      },
      success: function (response) {
        alert('Stock updated successfully!');
        window.location.href = '/dashboard/';
      },
      error: function (xhr) {
        if (xhr.status === 401 || xhr.status === 403) {
          alert("Session expired. Please login again.");
          localStorage.clear();
          window.location.href = "/";
        } else {
          let errorMsg = xhr.responseJSON?.detail || "Something went wrong.";
          alert("Error: " + errorMsg);
        }
      }
    });
  });
</script>

{% endblock %}
