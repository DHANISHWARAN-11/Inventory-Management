{% extends 'base.html' %}
{% block content %}

<div class="text-center mt-4">
  <h1 class="fw-bold">Welcome to Mini Inventory Tracker</h1>
  <p class="text-muted">Manage items, add stock, and monitor inventory in real-time.</p>
</div>

<!-- Categories Section -->
{% include 'includes/error.html' %}
<div class="row mt-5" id="category-container">
  <!-- Injected via JavaScript -->
</div>
<!-- Item display container -->
<div id="item-container" class="mt-4">
  <!-- Injected via JavaScript -->
</div>


<script>
  const accessToken = localStorage.getItem('access');
  if (!accessToken) {
    alert("You are not logged in. Please login.");
    window.location.href = "/";
  }
  

  // Load categories on page load
  $(document).ready(function () {
    $.ajax({
      url: '/api/categories/',
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + accessToken
        
      },
      success: function (data) {
        const container = $('#category-container');
        data.forEach(function (category) {
          const card = `
            <div class="col-md-4 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <h5 class="card-title">
                    <a href="#" onclick="loadItems(${category.id}, '${category.name}')" class="text-decoration-none text-primary">
                      ${category.name} (${category.item_count})
                    </a>
                  </h5>
                  <p class="card-text text-muted">${category.description || ''}</p>
                </div>
              </div>
            </div>
          `;
          container.append(card);
        });
      },
      error: function (xhr) {
        if (xhr.status === 401 || xhr.status === 403) {
          alert("Session expired or unauthorized. Please login again.");
          localStorage.removeItem("access");
          localStorage.removeItem("refresh");
          window.location.href = "/";
        } else {
          $('#category-container').html('<p class="text-danger text-center">Failed to load categories.</p>');
        }
      }
    });
  });

  // Load items when a category is clicked
  function loadItems(categoryId, categoryName) {
    const accessToken = localStorage.getItem('access');
    if (!accessToken) {
      alert("You are not logged in. Please login.");
      window.location.href = "/";
    }
    
    $('#item-container').html(''); // clear previous items

    $.ajax({
      url: `/api/items?category_id=${categoryId}`,
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + accessToken
      },
      success: function (items) {
        console.log(items)
        if (items.length === 0) {
          $('#item-container').html(`<p class="text-center text-muted">No items in "${categoryName}" category.</p>`);
          return;
        }

        let html = `
        <div class="card mt-5 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Items in ${categoryName} Category</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Item Name</th>
                  <th>Current Stock</th>
                  <th>Add-Reduce</th>
                </tr>
              </thead>
              <tbody>`;

        items.forEach(function (item) {
          html += `
            <tr>
              <td>${item.name}</td>
              <td>${item.current_stock}</td>
              <td>
                <a href="/add_reduce_stock/${categoryName}/${item.name}/add/" class="btn btn-sm btn-success">Add</a>
                <a href="/add_reduce_stock/${categoryName}/${item.name}/reduce/" class="btn btn-sm btn-danger">Reduce</a>
              </td>
            </tr>`;
        });

        html += `</tbody></table></div></div>`;
        $('#item-container').html(html);
      },
      error: function () {
        $('#item-container').html('<p class="text-danger text-center">Failed to load items for this category.</p>');
      }
    });
  }
</script>

{% endblock %}
