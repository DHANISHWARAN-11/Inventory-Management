{% extends 'base.html' %}
{% block content %}

<!-- ✅ Welcome Section -->
<div class="text-center mt-4">
  <h1 class="fw-bold">Welcome to Mini Inventory Tracker</h1>
  <p class="text-muted">Manage items, add stock, and monitor inventory in real-time.</p>
</div>

<!-- ✅ Download CSV Button -->
<div class="text-center mt-4">
  <button onclick="downloadCSV()" class="btn btn-outline-success">Download Items CSV</button>
</div>

<!-- ✅ CSV Upload and Preview Section -->
<div class="text-center mt-4">
  <label for="categoryItemFile">Upload Category + Items CSV:</label>
  <input type="file" id="categoryItemFile" accept=".csv" class="form-control w-50 mx-auto mb-2">
  <button onclick="uploadCSVToServer()" class="btn btn-outline-info">Upload & Save to DB</button>
</div>


<!-- ✅ Category and Item Containers -->
{% include 'includes/error.html' %}
<div class="row mt-5" id="category-container">
  <!-- Injected category cards -->
</div>

<div id="item-container" class="mt-4">
  <!-- Injected item tables -->
</div>

<!-- ✅ 1. Load Categories from API and Render -->
<script>
  const accessToken = localStorage.getItem('access');
  if (!accessToken) {
    alert("You are not logged in. Please login.");
    window.location.href = "/";
  }

  $(document).ready(function () {
    $.ajax({
      url: '/api/categories/',
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + accessToken
      },
      success: function (data) {
        const container = $('#category-container');
        data.forEach(function (category) {
          const card = `
            <div class="col-md-4 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <h5 class="card-title">
                    <a href="#" onclick="loadItems(${category.id}, '${category.name}')" class="text-decoration-none text-primary">
                      ${category.name} (${category.item_count})
                    </a>
                  </h5>
                  <p class="card-text text-muted">${category.description || ''}</p>
                </div>
              </div>
            </div>
          `;
          container.append(card);
        });
      },
      error: function (xhr) {
        if (xhr.status === 401 || xhr.status === 403) {
          alert("Session expired. Please login again.");
          localStorage.removeItem("access");
          localStorage.removeItem("refresh");
          window.location.href = "/";
        } else {
          $('#category-container').html('<p class="text-danger text-center">Failed to load categories.</p>');
        }
      }
    });
  });

  function loadItems(categoryId, categoryName) {
    $('#item-container').html('');

    $.ajax({
      url: `/api/items?category_id=${categoryId}`,
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + accessToken
      },
      success: function (items) {
        if (items.length === 0) {
          $('#item-container').html(`<p class="text-center text-muted">No items in "${categoryName}" category.</p>`);
          return;
        }

        let html = `
          <div class="card mt-5 shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Items in ${categoryName} Category</h5>
            </div>
            <div class="card-body">
              <table class="table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Current Stock</th>
                    <th>Add-Reduce</th>
                  </tr>
                </thead>
                <tbody>`;

        items.forEach(function (item) {
          html += `
            <tr>
              <td>${item.name}</td>
              <td>${item.current_stock}</td>
              <td>
                <a href="/add_reduce_stock/${categoryName}/${item.name}/add/" class="btn btn-sm btn-success">Add</a>
                <a href="/add_reduce_stock/${categoryName}/${item.name}/reduce/" class="btn btn-sm btn-danger">Reduce</a>
              </td>
            </tr>`;
        });

        html += `</tbody></table></div></div>`;
        $('#item-container').html(html);
      },
      error: function () {
        $('#item-container').html('<p class="text-danger text-center">Failed to load items for this category.</p>');
      }
    });
  }
</script>

<!-- ✅ 2. Download CSV API -->
<script>
function downloadCSV() {
  const accessToken = localStorage.getItem('access');
  if (!accessToken) {
    alert("You are not logged in.");
    return;
  }

  const xhr = new XMLHttpRequest();
  xhr.open("GET", "/api/export/items/", true);
  xhr.setRequestHeader("Authorization", "Bearer " + accessToken);
  xhr.responseType = "blob";

  xhr.onload = function () {
    if (xhr.status === 200) {
      const blob = new Blob([xhr.response], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = "items.csv";
      link.click();
    } else {
      alert("Failed to download CSV.");
    }
  };
  xhr.send();
}
</script>

<!-- ✅ 3. CSV Upload Preview Script -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let globalCSVData = {};

function previewCategoriesAndItemsFromCSV() {
  const fileInput = document.getElementById('categoryItemFile');
  const file = fileInput.files[0];

  if (!file) {
    alert("Please select a CSV file.");
    return;
  }

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const data = results.data;
      if (!data.length) {
        alert("CSV file is empty.");
        return;
      }

      const categoryMap = {};

      data.forEach(row => {
        const catName = row['category'] || 'Unnamed Category';
        const catDesc = row['description'] || '';
        const itemName = row['name'] || 'Unnamed Item';
        const stock = row['current_stock'] || '0';

        if (!categoryMap[catName]) {
          categoryMap[catName] = {
            description: catDesc,
            items: []
          };
        }

        categoryMap[catName].items.push({
          name: itemName,
          stock: stock
        });

        globalCSVData[catName] = categoryMap[catName]; // Save for clicking
      });

      const container = $('#category-container');
      const itemContainer = $('#item-container');
      container.html('');
      itemContainer.html('');

      Object.entries(categoryMap).forEach(([catName, catData]) => {
        const card = `
          <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100 border-info">
              <div class="card-body text-center">
                <h5 class="card-title">
                  <a href="#" onclick="showCSVItems('${catName}')" class="text-decoration-none text-info">
                    ${catName} (${catData.items.length})
                  </a>
                </h5>
                <p class="card-text">${catData.description}</p>
              </div>
            </div>
          </div>
        `;
        container.append(card);
      });
    },
    error: function(err) {
      alert("CSV parse error: " + err.message);
    }
  });
}

function showCSVItems(categoryName) {
  const itemContainer = $('#item-container');
  itemContainer.html('');

  const items = globalCSVData[categoryName]?.items || [];

  if (items.length === 0) {
    itemContainer.html(`<p class="text-muted text-center">No items found in ${categoryName}</p>`);
    return;
  }

  let html = `
    <div class="card mt-5 shadow-sm">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Items in ${categoryName}</h5>
      </div>
      <div class="card-body">
        <table class="table">
          <thead><tr><th>Item Name</th><th>Stock</th></tr></thead>
          <tbody>`;

  items.forEach(item => {
    html += `<tr><td>${item.name}</td><td>${item.stock}</td></tr>`;
  });

  html += `</tbody></table></div></div>`;
  itemContainer.append(html);
}

//CSV Upload to Backend
function uploadCSVToServer() {
  const fileInput = document.getElementById('categoryItemFile');
  const file = fileInput.files[0];
  const accessToken = localStorage.getItem('access');

  if (!file) {
    alert("Please choose a CSV file.");
    return;
  }

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function (results) {
      const data = results.data;

      fetch("/api/import/categories-items/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + accessToken
        },
        body: JSON.stringify({ rows: data })
      })
      .then(response => response.json())
      .then(res => {
        if (res.success) {
          alert("Data uploaded and saved successfully!");
          location.reload(); // refresh to show new data
        } else {
          alert("Upload failed: " + res.message);
        }
      })
      .catch(err => {
        alert("Error: " + err.message);
      });
    }
  });
}

</script>

{% endblock %}
